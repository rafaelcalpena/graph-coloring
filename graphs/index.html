<html>

<head>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
    <script src="https://cytoscape.org/cytoscape.js-dagre/cytoscape-dagre.js"></script>
    <script src="https://unpkg.com/@stackomate/data-structures@1.1.0/dist/data-structures.umd.js"></script>
    <script src="../data/propagator-tree.js"></script>
    <script src="../data/data.js"></script>

    <script src="https://unpkg.com/popper.js@1.14.7/dist/umd/popper.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cytoscape-popper@1.0.4/cytoscape-popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@4.0.1/umd/index.all.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@4.0.1/index.css" />
    <style>
        body {
            font-family: helvetica;
            font-size: 14px;
        }

        #cy {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 999;
        }

        h1 {
            opacity: 0.5;
            font-size: 1em;
        }

        #summary {
            width: 300px;
            background: rgba(150, 150, 250, 0.5);
            z-index: 100000;
            padding: 1rem;
            border-radius: 5px;
            position: relative;
            max-height: 500px;
            overflow: auto;
        }
    </style>
    <script>

        window.addEventListener('DOMContentLoaded', function () {

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            const item = parseInt(urlParams.get('c'), 10) || 0;

            var cy = window.cy = cytoscape({
                container: document.getElementById('cy'),

                boxSelectionEnabled: false,
                autounselectify: true,

                layout: {
                    name: 'dagre'
                },

                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#11479e'
                        }
                    },

                    {
                        selector: 'edge',
                        style: {
                            'width': 4,
                            'target-arrow-shape': 'triangle',
                            'line-color': '#9dbaea',
                            'target-arrow-color': '#9dbaea',
                            'curve-style': 'bezier'
                        }
                    }
                ],

                elements: graphResult[item]
            });

            /* Source: https://stackoverflow.com/questions/58899397/tooltip-with-cytoscape-js-and-angular8 */
            function makePopper(ele) {
                let ref = ele.popperRef(); // used only for positioning
                let domains = new dataStructures.BidirectionalTupleSet([]);
                if (ele.isNode()) {
                    let tuples = Object.keys(dataResult.domains).map(k => dataResult.domains[k].map(v => [k, v])).flat();
                    domains = new dataStructures.BidirectionalTupleSet(tuples);

                    let rels = new dataStructures.BidirectionalTupleSet(info.rels[item]);

                    let cId = ele.data('id');
                    let parentIds = rels.inverseGet(parseInt(cId, 10));
                    let prune1 = ele.data().prune;
                    prune1.forEach(p => {
                        domains = domains.delete(p[0], p[1]);
                    })
                    while (parentIds.size > 0) {
                        let parentId = [...parentIds][0];
                        let parentData = cy.getElementById('' + parentId).data();

                        let parentEdges = cy.getElementById(''+ parentId + '-' + cId);
                        if (parentEdges.length > 0) {
                            if (parentEdges[0].data('isDeleteBranch') === true) {
                                domains = domains.delete(parentData.test[0], parentData.test[1])
                            }
                        }

                        let prune = parentData.prune;
                        prune.forEach(p => {
                            domains = domains.delete(p[0], p[1]);
                        })
                        cId = parentId;
                        parentIds = rels.inverseGet(parentId);
                    }
                }

                ele.tippy = tippy(ref, {
                    // tippy options:
                    content: () => {
                        let content = document.createElement("div");
                        content.innerHTML =
                            // ele.data('source') ? 
                            // `<code> ${ele.data('source')} </code>`
                            // : 
                            `<code> ${ele.data('label')?.replace(/\</g, '&lt;').replace(/\>/g, '&gt;')} </code>` +
                            (ele.isNode() ? `<br/><br/><code>D={${[...domains].map(t => `(${t[0]},${t[1]})`).join(', ')}}</code>` : ``);

                        return content;
                    },
                    trigger: "manual" // probably want manual mode
                });
            }

            cy.ready(function () {
                // cy.elements().forEach(function (ele) {
                // });
            });

            cy.elements().unbind("mouseover");
            cy.elements().bind("mouseover", event => {
                makePopper(event.target);
                event.target.tippy.show()
            });

            cy.elements().unbind("mouseout");
            cy.elements().bind("mouseout", event => event.target.tippy.hide());

            document.querySelectorAll('[data-get="initial-domains"]').forEach(i => {
                i.innerHTML = JSON.stringify(dataResult.domains, null, 2);
            })

            document.querySelectorAll('[data-get="constraints"]').forEach((i) => {
                i.innerHTML = dataResult.constraints.map((i, index) => `<a href="index.html?c=${index}">${i.join(' ')} (Nodes: ${info.nodesLength[index]}, Edges: ${info.edgesLength[index]})</a>`).join('<br/>');
            })

        });

    </script>
</head>

<body>
    <div id="cy"></div>
    <div id="summary">
        <code>
            Initial Domains<br/>
            <pre data-get="initial-domains"></pre>
            Constraints
            <pre data-get="constraints"></pre>
        </code>
    </div>
</body>

</html>